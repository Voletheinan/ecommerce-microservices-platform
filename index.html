<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõçÔ∏è Ecommerce Microservices Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            color: #667eea;
        }

        .auth-info {
            text-align: right;
        }

        .auth-info p {
            color: #666;
            margin: 5px 0;
        }

        .auth-info .logged-in {
            color: green;
            font-weight: bold;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            height: fit-content;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .sidebar h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .menu-item {
            padding: 10px;
            margin: 5px 0;
            background: #f5f5f5;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background: #667eea;
            color: white;
            border-left-color: #764ba2;
        }

        .menu-item.active {
            background: #667eea;
            color: white;
            border-left-color: #764ba2;
        }

        .content-area {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: slideIn 0.3s ease-in;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h2 {
            color: #667eea;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button.secondary {
            background: #999;
            margin-left: 10px;
        }

        button.secondary:hover {
            background: #777;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .result {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }

        .result.success {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .result.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .result.info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }

        .result h4 {
            margin-bottom: 10px;
        }

        .result pre {
            background: white;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }

        .product-card {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .product-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .product-card p {
            color: #666;
            margin: 5px 0;
        }

        .price {
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
        }

        .list-item {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
        }

        .list-item:hover {
            background: #f0f0f0;
        }

        .list-item strong {
            color: #667eea;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                text-align: center;
            }

            .auth-info {
                margin-top: 10px;
                text-align: center;
            }
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-processing {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .summary {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .summary-row:last-child {
            border-bottom: none;
        }

        .summary-row strong {
            color: #667eea;
        }

        .total {
            background: #667eea;
            color: white;
            padding: 12px;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            margin-top: 10px;
            text-align: right;
        }

        .notification {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .notification.warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .notification.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div>
                <h1>üõçÔ∏è Ecommerce Demo System</h1>
                <p style="color: #999; margin-top: 5px;">Microservices Architecture</p>
            </div>
            <div class="auth-info">
                <p id="userStatus">Ch∆∞a ƒëƒÉng nh·∫≠p</p>
                <p id="userInfo"></p>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar Menu -->
            <div class="sidebar">
                <h3>üìã MENU</h3>
                
                <div class="menu-item active" onclick="showSection('auth')">üîê X√°c Th·ª±c</div>
                <div class="menu-item" onclick="showSection('products')">üì¶ S·∫£n Ph·∫©m</div>
                <div class="menu-item" onclick="showSection('orders')">üõí ƒê∆°n H√†ng</div>
                <div class="menu-item" onclick="showSection('payment')">üí≥ Thanh To√°n</div>
                <div class="menu-item" onclick="showSection('shipping')">üì¶ Giao V·∫≠n</div>
                <div class="menu-item" onclick="showSection('promotions')">üéâ Khuy·∫øn M√£i</div>
                <div class="menu-item" onclick="showSection('ratings')">‚≠ê ƒê√°nh Gi√°</div>
                <div class="menu-item" onclick="showSection('favourite')">‚ù§Ô∏è Y√™u Th√≠ch</div>
                <div class="menu-item" onclick="showSection('notifications')">üì¨ Th√¥ng B√°o</div>
                <div class="menu-item" onclick="showSection('inventory')">üìä Kho H√†ng</div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- AUTH SECTION -->
                <div id="auth" class="section active">
                    <h2>üîê X√°c Th·ª±c Ng∆∞·ªùi D√πng</h2>

                    <div style="background: #f0f0f0; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                        <h4>ƒêƒÉng K√Ω T√†i Kho·∫£n</h4>
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="regEmail" placeholder="user@example.com">
                        </div>
                        <div class="form-group">
                            <label>T√™n ƒêƒÉng Nh·∫≠p:</label>
                            <input type="text" id="regUsername" placeholder="username">
                        </div>
                        <div class="form-group">
                            <label>M·∫≠t Kh·∫©u:</label>
                            <input type="password" id="regPassword" placeholder="Password@123">
                        </div>
                        <div class="form-group">
                            <label>T√™n ƒê·∫ßy ƒê·ªß:</label>
                            <input type="text" id="regFullname" placeholder="Nguy·ªÖn VƒÉn A">
                        </div>
                        <div class="form-group">
                            <label>ƒêi·ªán Tho·∫°i:</label>
                            <input type="tel" id="regPhone" placeholder="0987654321">
                        </div>
                        <div class="form-group">
                            <label>ƒê·ªãa Ch·ªâ:</label>
                            <textarea id="regAddress" rows="2" placeholder="123 L√™ L·ª£i, TP.HCM"></textarea>
                        </div>
                        <button onclick="registerUser()"> ƒêƒÉng K√Ω</button>
                    </div>

                    <div style="background: #e8f5e9; padding: 15px; border-radius: 5px;">
                        <h4>ƒêƒÉng Nh·∫≠p</h4>
                        <div class="form-group">
                            <label>T√™n ƒêƒÉng Nh·∫≠p:</label>
                            <input type="text" id="loginUsername" placeholder="username">
                        </div>
                        <div class="form-group">
                            <label>M·∫≠t Kh·∫©u:</label>
                            <input type="password" id="loginPassword" placeholder="Password">
                        </div>
                        <button onclick="loginUser()">üîì ƒêƒÉng Nh·∫≠p</button>
                    </div>

                    <div id="authResult"></div>
                </div>

                <!-- PRODUCTS SECTION -->
                <div id="products" class="section">
                    <h2>üì¶ Danh S√°ch S·∫£n Ph·∫©m</h2>
                    <button onclick="getProducts()">üì• T·∫£i Danh S√°ch</button>
                    <button onclick="searchProducts()">üîç T√¨m Ki·∫øm</button>
                    <div id="productsList" style="margin-top: 20px;"></div>
                </div>

                <!-- ORDERS SECTION -->
                <div id="orders" class="section">
                    <h2>üõí T·∫°o ƒê∆°n H√†ng</h2>
                    <div class="form-group">
                        <label>ID S·∫£n Ph·∫©m:</label>
                        <input type="text" id="productId" placeholder="Sao ch√©p t·ª´ danh s√°ch s·∫£n ph·∫©m">
                    </div>
                    <div class="form-group">
                        <label>S·ªë L∆∞·ª£ng:</label>
                        <input type="number" id="quantity" value="1" min="1" onchange="calculateTotal()">
                    </div>
                    <div class="form-group">
                        <label>Gi√° ƒê∆°n V·ªã (VND):</label>
                        <input type="number" id="productPrice" placeholder="29999000" readonly style="background: #f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label>Khuy·∫øn M√£i:</label>
                        <select id="promotionId" onchange="calculateTotal()">
                            <option value="">-- Kh√¥ng c√≥ khuy·∫øn m√£i --</option>
                            <option value="loading">‚è≥ ƒêang t·∫£i...</option>
                        </select>
                        <small id="promotionInfo" style="color: #666; margin-top: 5px; display: block;"></small>
                    </div>
                    <div class="form-group">
                        <label>Thu·∫ø:</label>
                        <select id="taxId" onchange="calculateTotal()">
                            <option value="">-- Kh√¥ng c√≥ thu·∫ø --</option>
                            <option value="loading">‚è≥ ƒêang t·∫£i...</option>
                        </select>
                        <small id="taxInfo" style="color: #666; margin-top: 5px; display: block;"></small>
                    </div>
                    <div class="summary">
                        <div class="summary-row">
                            <strong>T·ªïng Tr∆∞·ªõc Khuy·∫øn M√£i:</strong>
                            <span id="subtotal">0</span> VND
                        </div>
                        <div class="summary-row">
                            <strong>Chi·∫øt Kh·∫•u:</strong>
                            <span id="discountAmount">0</span> VND
                        </div>
                        <div class="summary-row">
                            <strong>Sau Khuy·∫øn M√£i:</strong>
                            <span id="afterDiscount">0</span> VND
                        </div>
                        <div class="summary-row">
                            <strong>Thu·∫ø:</strong>
                            <span id="taxAmount">0</span> VND
                        </div>
                        <div class="total">
                            T·ªïng C·ªông: <span id="finalTotal">0</span> VND
                        </div>
                    </div>
                    <button onclick="createOrder()">üõí T·∫°o ƒê∆°n H√†ng</button>
                    <div id="orderResult"></div>

                    <hr style="margin: 20px 0;">
                    <h3>Danh S√°ch ƒê∆°n H√†ng C·ªßa B·∫°n</h3>
                    <button onclick="getMyOrders()">üì• Xem ƒê∆°n H√†ng</button>
                    <div id="myOrdersList" style="margin-top: 15px;"></div>
                </div>

                <!-- PAYMENT SECTION -->
                <div id="payment" class="section">
                    <h2>üí≥ Thanh To√°n</h2>
                    <div class="form-group">
                        <label>ID ƒê∆°n H√†ng:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="paymentOrderId" placeholder="1" style="flex: 1;">
                            <button onclick="copyToInput('paymentOrderId')" style="flex: 0 0 auto; padding: 10px 15px;">üìã D√°n t·ª´ ƒê∆°n H√†ng</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>S·ªë Ti·ªÅn (VND):</label>
                        <input type="number" id="paymentAmount" placeholder="32998900">
                    </div>
                    <div class="form-group">
                        <label>Ph∆∞∆°ng Th·ª©c:</label>
                        <select id="paymentMethod">
                            <option value="credit_card">Th·∫ª T√≠n D·ª•ng</option>
                            <option value="debit_card">Th·∫ª Ghi N·ª£</option>
                            <option value="bank_transfer">Chuy·ªÉn Kho·∫£n</option>
                            <option value="e_wallet">E-Wallet</option>
                            <option value="cod">Thu Ti·ªÅn Khi Nh·∫≠n</option>
                        </select>
                    </div>
                    <button onclick="processPayment()">üí∞ Thanh To√°n</button>
                    <div id="paymentResult"></div>
                </div>

                <!-- SHIPPING SECTION -->
                <div id="shipping" class="section">
                    <h2>üì¶ Giao V·∫≠n & Tracking</h2>
                    <div class="form-group">
                        <label>S·ªë Tracking:</label>
                        <input type="text" id="trackingNumber" placeholder="VN123456789">
                    </div>
                    <button onclick="trackShipping()">üîç Tra C·ª©u</button>
                    <div id="shippingResult"></div>

                    <hr style="margin: 20px 0;">
                    <h3>T·∫°o Giao V·∫≠n (Admin)</h3>
                    <div class="form-group">
                        <label>ID ƒê∆°n H√†ng:</label>
                        <input type="number" id="shipmentOrderId" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label>ƒê·ªãa Ch·ªâ Giao:</label>
                        <textarea id="shipmentAddress" rows="2" placeholder="123 L√™ L·ª£i, TP.HCM"></textarea>
                    </div>
                    <button onclick="createShipment()">üì¶ T·∫°o Giao V·∫≠n</button>
                    <div id="createShipmentResult"></div>
                </div>

                <!-- PROMOTIONS SECTION -->
                <div id="promotions" class="section">
                    <h2>üéâ Khuy·∫øn M√£i & M√£ Gi·∫£m Gi√°</h2>
                    <button onclick="getPromotions()">üì• Xem Khuy·∫øn M√£i</button>
                    <div id="promotionsList" style="margin-top: 20px;"></div>

                    <hr style="margin: 20px 0;">
                    <h3>√Åp D·ª•ng M√£ Gi·∫£m Gi√°</h3>
                    <div class="form-group">
                        <label>M√£ Gi·∫£m Gi√°:</label>
                        <input type="text" id="couponCode" placeholder="BLACKFRIDAY50">
                    </div>
                    <div class="form-group">
                        <label>ID ƒê∆°n H√†ng:</label>
                        <input type="number" id="couponOrderId" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label>Gi√° G·ªëc (VND):</label>
                        <input type="number" id="couponAmount" placeholder="59998000">
                    </div>
                    <button onclick="applyCoupon()"> √Åp D·ª•ng</button>
                    <div id="couponResult"></div>
                </div>

                <!-- RATINGS SECTION -->
                <div id="ratings" class="section">
                    <h2>‚≠ê ƒê√°nh Gi√° S·∫£n Ph·∫©m</h2>
                    <div class="form-group">
                        <label>ID S·∫£n Ph·∫©m:</label>
                        <input type="text" id="ratingProductId" placeholder="Sao ch√©p t·ª´ danh s√°ch s·∫£n ph·∫©m">
                    </div>
                    <div class="form-group">
                        <label>X·∫øp H·∫°ng:</label>
                        <select id="ratingScore">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê R·∫•t T·ªët (5 sao)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê T·ªët (4 sao)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê B√¨nh Th∆∞·ªùng (3 sao)</option>
                            <option value="2">‚≠ê‚≠ê T·ªá (2 sao)</option>
                            <option value="1">‚≠ê R·∫•t T·ªá (1 sao)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ti√™u ƒê·ªÅ:</label>
                        <input type="text" id="ratingTitle" placeholder="S·∫£n ph·∫©m tuy·ªát v·ªùi!">
                    </div>
                    <div class="form-group">
                        <label>Nh·∫≠n X√©t:</label>
                        <textarea id="ratingComment" rows="3" placeholder="H√£y chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n..."></textarea>
                    </div>
                    <button onclick="submitRating()"> G·ª≠i ƒê√°nh Gi√°</button>
                    <div id="ratingResult"></div>

                    <hr style="margin: 20px 0;">
                    <h3>Xem ƒê√°nh Gi√° S·∫£n Ph·∫©m</h3>
                    <div class="form-group">
                        <label>ID S·∫£n Ph·∫©m:</label>
                        <input type="text" id="viewRatingProductId" placeholder="Sao ch√©p t·ª´ danh s√°ch s·∫£n ph·∫©m">
                    </div>
                    <button onclick="viewProductRatings()">üìä Xem ƒê√°nh Gi√°</button>
                    <div id="productRatingsResult"></div>
                </div>

                <!-- FAVOURITE SECTION -->
                <div id="favourite" class="section">
                    <h2>‚ù§Ô∏è S·∫£n Ph·∫©m Y√™u Th√≠ch</h2>
                    <div class="form-group">
                        <label>ID S·∫£n Ph·∫©m:</label>
                        <input type="text" id="favProductId" placeholder="Sao ch√©p t·ª´ danh s√°ch s·∫£n ph·∫©m">
                    </div>
                    <button onclick="addToFavourite()">‚ù§Ô∏è Th√™m Y√™u Th√≠ch</button>
                    <div id="favResult"></div>

                    <hr style="margin: 20px 0;">
                    <h3>Danh S√°ch Y√™u Th√≠ch</h3>
                    <button onclick="getFavourites()">üì• Xem Danh S√°ch</button>
                    <div id="favouritesList" style="margin-top: 15px;"></div>
                </div>

                <!-- NOTIFICATIONS SECTION -->
                <div id="notifications" class="section">
                    <h2>üì¨ Th√¥ng B√°o</h2>
                    <button onclick="getNotifications()">üîî Xem Th√¥ng B√°o</button>
                    <div id="notificationsList" style="margin-top: 20px;"></div>
                </div>

                <!-- INVENTORY SECTION -->
                <div id="inventory" class="section">
                    <h2>üìä Ki·ªÉm Tra Kho (Admin)</h2>
                    <div class="form-group">
                        <label>ID S·∫£n Ph·∫©m:</label>
                        <input type="text" id="inventoryProductId" placeholder="Sao ch√©p t·ª´ danh s√°ch s·∫£n ph·∫©m">
                    </div>
                    <button onclick="checkInventory()">üì¶ Ki·ªÉm Tra Kho</button>
                    <div id="inventoryResult"></div>

                    <hr style="margin: 20px 0;">
                    <h3>S·∫£n Ph·∫©m S·∫Øp H·∫øt</h3>
                    <button onclick="getLowStock()">‚ö†Ô∏è Xem S·∫Øp H·∫øt</button>
                    <div id="lowStockResult"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = '';  // Use relative paths through Nginx gateway
        let authToken = localStorage.getItem('authToken') || '';
        let userId = localStorage.getItem('userId') || '';
        let username = localStorage.getItem('username') || '';

        // Update UI on page load
        window.onload = function() {
            updateAuthStatus();
            getProducts();  // Auto-load products when page loads
        };

        // Menu Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
        }

        // Update Auth Status
        function updateAuthStatus() {
            const statusEl = document.getElementById('userStatus');
            const infoEl = document.getElementById('userInfo');
            
            if (authToken) {
                statusEl.innerHTML = ' <span class="logged-in">ƒê√£ ƒêƒÉng Nh·∫≠p</span>';
                infoEl.innerHTML = `üë§ ${username}`;
            } else {
                statusEl.innerHTML = '‚ùå Ch∆∞a ƒêƒÉng Nh·∫≠p';
                infoEl.innerHTML = '';
            }
        }

        // REGISTER
        async function registerUser() {
            const email = document.getElementById('regEmail').value;
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const fullName = document.getElementById('regFullname').value;
            const phone = document.getElementById('regPhone').value;
            const address = document.getElementById('regAddress').value;

            if (!email || !username || !password) {
                showResult('authResult', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/users/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email, username, password, full_name: fullName, phone, address
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    showResult('authResult', 
                        ` ƒêƒÉng K√Ω Th√†nh C√¥ng!\n\nID: ${data.id}\nT√™n: ${data.full_name}`, 
                        'success');
                    document.getElementById('regEmail').value = '';
                    document.getElementById('regUsername').value = '';
                    document.getElementById('regPassword').value = '';
                } else {
                    showResult('authResult', `‚ùå L·ªói: ${data.detail || 'ƒêƒÉng k√Ω th·∫•t b·∫°i'}`, 'error');
                }
            } catch (err) {
                showResult('authResult', `‚ùå L·ªói: ${err.message}`, 'error');
            }
        }

        // LOGIN
        async function loginUser() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showResult('authResult', 'Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p v√† m·∫≠t kh·∫©u!', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                if (response.ok) {
                    authToken = data.access_token;
                    userId = data.user_id;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('userId', userId);
                    localStorage.setItem('username', username);
                    
                    updateAuthStatus();
                    showResult('authResult', 
                        ` ƒêƒÉng Nh·∫≠p Th√†nh C√¥ng!\n\nCh√†o m·ª´ng: ${username}`, 
                        'success');
                    document.getElementById('loginUsername').value = '';
                    document.getElementById('loginPassword').value = '';
                } else {
                    showResult('authResult', `‚ùå L·ªói: ${data.detail || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i'}`, 'error');
                }
            } catch (err) {
                showResult('authResult', `‚ùå L·ªói: ${err.message}`, 'error');
            }
        }

        // GET PRODUCTS
        async function getProducts() {
            try {
                const response = await fetch(`/api/products?skip=0&limit=50`);
                const data = await response.json();
                
                if (!data.products || !Array.isArray(data.products)) {
                    document.getElementById('productsList').innerHTML = `<div class="notification error">Kh√¥ng c√≥ s·∫£n ph·∫©m</div>`;
                    return;
                }
                
                let html = `<h3>üì¶ T√¨m ƒë∆∞·ª£c ${data.total || data.products.length} s·∫£n ph·∫©m</h3>`;
                data.products.forEach(product => {
                    const productId = product._id || product.id;
                    const price = product.price || 0;
                    html += `
                        <div class="product-card">
                            <h4>${product.name}</h4>
                            <p>${product.description}</p>
                            <p class="price">üí∞ ${price.toLocaleString()} VND</p>
                            <p>üì¶ Kho: ${product.stock || product.inventory_count || 0} c√°i</p>
                            <button onclick="selectProduct('${productId}', ${price})">üìã Sao ch√©p ID</button>
                            <button onclick="copyToInput('viewRatingProductId', '${productId}')">‚≠ê ƒê√°nh Gi√°</button>
                        </div>
                    `;
                });
                document.getElementById('productsList').innerHTML = html;
            } catch (err) {
                document.getElementById('productsList').innerHTML = `<div class="notification error">L·ªói: ${err.message}</div>`;
            }
        }

        // CALCULATE TOTAL
        function calculateTotal() {
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const price = parseInt(document.getElementById('productPrice').value) || 0;
            const promotionId = document.getElementById('promotionId').value;
            const taxId = document.getElementById('taxId').value;

            // L·∫•y discount % t·ª´ khuy·∫øn m√£i ƒë∆∞·ª£c ch·ªçn
            let discountPercent = 0;
            if (promotionId) {
                const promotionOption = document.querySelector(`#promotionId option[value="${promotionId}"]`);
                if (promotionOption && promotionOption.dataset.discount) {
                    discountPercent = parseInt(promotionOption.dataset.discount) || 0;
                }
            }

            // L·∫•y tax % t·ª´ thu·∫ø ƒë∆∞·ª£c ch·ªçn
            let taxPercent = 0;
            if (taxId) {
                const taxOption = document.querySelector(`#taxId option[value="${taxId}"]`);
                if (taxOption && taxOption.dataset.rate) {
                    taxPercent = parseInt(taxOption.dataset.rate) || 0;
                }
            }

            const subtotal = price * quantity;
            const discountAmount = Math.round(subtotal * discountPercent / 100);
            const afterDiscount = subtotal - discountAmount;
            const taxAmount = Math.round(afterDiscount * taxPercent / 100);
            const finalTotal = afterDiscount + taxAmount;

            // Hi·ªÉn th·ªã th√¥ng tin khuy·∫øn m√£i
            if (promotionId) {
                const promotionOption = document.querySelector(`#promotionId option[value="${promotionId}"]`);
                if (promotionOption) {
                    document.getElementById('promotionInfo').textContent = `üì¢ ${promotionOption.textContent}`;
                }
            } else {
                document.getElementById('promotionInfo').textContent = '';
            }

            // Hi·ªÉn th·ªã th√¥ng tin thu·∫ø
            if (taxId) {
                const taxOption = document.querySelector(`#taxId option[value="${taxId}"]`);
                if (taxOption) {
                    document.getElementById('taxInfo').textContent = `üìã ${taxOption.textContent}`;
                }
            } else {
                document.getElementById('taxInfo').textContent = '';
            }

            document.getElementById('subtotal').textContent = subtotal.toLocaleString();
            document.getElementById('discountAmount').textContent = discountAmount.toLocaleString();
            document.getElementById('afterDiscount').textContent = afterDiscount.toLocaleString();
            document.getElementById('taxAmount').textContent = taxAmount.toLocaleString();
            document.getElementById('finalTotal').textContent = finalTotal.toLocaleString();
        }

        // CREATE ORDER
        async function createOrder() {
            if (!authToken) {
                showResult('orderResult', 'Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!', 'error');
                return;
            }

            const productId = document.getElementById('productId').value;
            const quantity = parseInt(document.getElementById('quantity').value);
            const price = parseInt(document.getElementById('productPrice').value);
            const promotionId = document.getElementById('promotionId').value;
            const taxId = document.getElementById('taxId').value;

            if (!productId || !quantity || !price) {
                showResult('orderResult', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }

            try {
                // L·∫•y discount % t·ª´ khuy·∫øn m√£i ƒë∆∞·ª£c ch·ªçn
                let discountPercent = 0;
                if (promotionId) {
                    const promotionOption = document.querySelector(`#promotionId option[value="${promotionId}"]`);
                    if (promotionOption && promotionOption.dataset.discount) {
                        discountPercent = parseInt(promotionOption.dataset.discount) || 0;
                    }
                }

                // L·∫•y tax % t·ª´ thu·∫ø ƒë∆∞·ª£c ch·ªçn
                let taxPercent = 0;
                if (taxId) {
                    const taxOption = document.querySelector(`#taxId option[value="${taxId}"]`);
                    if (taxOption && taxOption.dataset.rate) {
                        taxPercent = parseInt(taxOption.dataset.rate) || 0;
                    }
                }

                // T√≠nh to√°n t·ªïng ti·ªÅn
                const subtotal = price * quantity;
                const discountAmount = Math.round(subtotal * discountPercent / 100);
                const afterDiscount = subtotal - discountAmount;
                const taxAmount = Math.round(afterDiscount * taxPercent / 100);
                const totalAmount = afterDiscount + taxAmount;

                const orderData = {
                    user_id: parseInt(userId),
                    items: [{ product_id: productId, quantity, price }],
                    promotion_id: promotionId || null,
                    tax_id: taxId || null,
                    discount_percent: discountPercent,
                    discount_amount: discountAmount,
                    tax_percent: taxPercent,
                    tax_amount: taxAmount,
                    total_amount: totalAmount,
                    status: 'pending'
                };
                
                console.log('Sending order data:', orderData);
                
                const response = await fetch(`/api/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(orderData)
                });

                console.log('Order response status:', response.status);
                const data = await response.json();
                console.log('Order response data:', data);
                
                if (response.ok) {
                    const orderId = data.id || data._id || 'N/A';
                    console.log('Order created successfully with ID:', orderId);
                    showResult('orderResult', 
                        `ƒê∆°n h√†ng ƒë∆∞·ª£c t·∫°o!\n\nID: ${orderId}\nT·ªïng ti·ªÅn: ${(data.total_amount || 0).toLocaleString()} VND\n\nNh·∫•p n√∫t "üìã D√°n t·ª´ ƒê∆°n H√†ng" ·ªü ph·∫ßn Thanh To√°n ƒë·ªÉ ƒëi·ªÅn ID`, 
                        'success');
                    
                    // L∆∞u Order ID ƒë·ªÉ d√πng sau
                    window.lastOrderId = orderId;
                    console.log('Saved to window.lastOrderId:', window.lastOrderId);
                    
                } else {
                    console.error('Order creation failed:', data);
                    showResult('orderResult', `L·ªói: ${data.detail || 'T·∫°o ƒë∆°n h√†ng th·∫•t b·∫°i'}`, 'error');
                }
            } catch (err) {
                console.error('Order creation error:', err);
                showResult('orderResult', `L·ªói: ${err.message}`, 'error');
            }
        }

        // GET MY ORDERS
        async function getMyOrders() {
            if (!authToken) {
                showResult('myOrdersList', 'Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/orders?skip=0&limit=10`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                if (!data.orders || !Array.isArray(data.orders)) {
                    document.getElementById('myOrdersList').innerHTML = `<div class="notification error">Kh√¥ng c√≥ ƒë∆°n h√†ng</div>`;
                    return;
                }
                
                let html = `<h3>üìã ${data.orders.length} ƒë∆°n h√†ng</h3>`;
                
                if (data.orders.length === 0) {
                    html += '<p style="color: #999;">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</p>';
                } else {
                    data.orders.forEach(order => {
                        html += `
                            <div class="list-item">
                                <strong>ƒê∆°n #${order.id}</strong> | 
                                <span class="status-badge status-${order.status}">${order.status}</span>
                                <br>
                                T·ªïng: ${order.total_amount.toLocaleString()} VND | 
                                ${new Date(order.created_at).toLocaleDateString('vi-VN')}
                            </div>
                        `;
                    });
                }
                document.getElementById('myOrdersList').innerHTML = html;
            } catch (err) {
                showResult('myOrdersList', `L·ªói: ${err.message}`, 'error');
            }
        }

        // PROCESS PAYMENT
        async function processPayment() {
            if (!authToken) {
                showResult('paymentResult', '‚ùå Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!', 'error');
                return;
            }

            const orderId = parseInt(document.getElementById('paymentOrderId').value);
            const amount = parseInt(document.getElementById('paymentAmount').value);
            const method = document.getElementById('paymentMethod').value;

            if (!orderId || !amount) {
                showResult('paymentResult', '‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/payments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        order_id: orderId,
                        amount,
                        payment_method: method,
                        status: 'pending'
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    showResult('paymentResult', 
                        ` Thanh To√°n Th√†nh C√¥ng!\n\nID: ${data.id}\nS·ªë ti·ªÅn: ${amount.toLocaleString()} VND\nTransaction: ${data.transaction_id}`, 
                        'success');
                } else {
                    showResult('paymentResult', `‚ùå L·ªói: ${data.detail || 'Thanh to√°n th·∫•t b·∫°i'}`, 'error');
                }
            } catch (err) {
                showResult('paymentResult', `‚ùå L·ªói: ${err.message}`, 'error');
            }
        }

        // TRACK SHIPPING
        async function trackShipping() {
            const trackingNumber = document.getElementById('trackingNumber').value;
            if (!trackingNumber) {
                showResult('shippingResult', 'Vui l√≤ng nh·∫≠p s·ªë tracking!', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/shipments/track/${trackingNumber}`);
                const data = await response.json();
                
                if (!data.updates || !Array.isArray(data.updates)) {
                    showResult('shippingResult', 'Kh√¥ng t√¨m th·∫•y th√¥ng tin tracking', 'error');
                    return;
                }
                
                let html = `
                    <div class="notification info">
                        <strong>üì¶ Tracking: ${data.tracking_number}</strong><br>
                        Tr·∫°ng th√°i: <span class="status-badge status-${data.current_status}">${data.current_status}</span><br>
                        ƒê·ªãa ƒëi·ªÉm: ${data.location}
                    </div>
                    <h4>üìç L·ªãch s·ª≠:</h4>
                `;
                
                data.updates.forEach(update => {
                    html += `
                        <div class="list-item">
                            <strong>${update.status}</strong> - ${new Date(update.timestamp).toLocaleString('vi-VN')}
                        </div>
                    `;
                });
                
                document.getElementById('shippingResult').innerHTML = html;
            } catch (err) {
                showResult('shippingResult', `‚ùå L·ªói: ${err.message}`, 'error');
            }
        }

        // CREATE SHIPMENT
        async function createShipment() {
            if (!authToken) {
                showResult('createShipmentResult', '‚ùå Vui l√≤ng ƒëƒÉng nh·∫≠p (Admin)!', 'error');
                return;
            }

            const orderId = parseInt(document.getElementById('shipmentOrderId').value);
            const address = document.getElementById('shipmentAddress').value;

            if (!orderId || !address) {
                showResult('createShipmentResult', '‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/shipments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        order_id: orderId,
                        address,
                        phone: '0987654321',
                        carrier: 'GHN',
                        status: 'pending'
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    showResult('createShipmentResult', 
                        ` Giao v·∫≠n ƒë∆∞·ª£c t·∫°o!\n\nTracking: ${data.tracking_number}\nCarrier: ${data.carrier}`, 
                        'success');
                } else {
                    showResult('createShipmentResult', `‚ùå L·ªói: ${data.detail || 'T·∫°o giao v·∫≠n th·∫•t b·∫°i'}`, 'error');
                }
            } catch (err) {
                showResult('createShipmentResult', `‚ùå L·ªói: ${err.message}`, 'error');
            }
        }

        // GET PROMOTIONS
        async function getPromotions() {
            try {
                const response = await fetch(`/api/promotions?status=active`);
                const data = await response.json();
                
                if (!data.promotions || !Array.isArray(data.promotions)) {
                    document.getElementById('promotionsList').innerHTML = `<div class="notification">Kh√¥ng c√≥ khuy·∫øn m√£i</div>`;
                    return;
                }
                
                let html = `<h3>üéâ ${data.promotions.length} khuy·∫øn m√£i ƒëang ho·∫°t ƒë·ªông</h3>`;
                
                if (data.promotions.length > 0) {
                    data.promotions.forEach(promo => {
                        html += `
                            <div class="list-item">
                                <strong>${promo.name}</strong><br>
                                Gi·∫£m: ${promo.discount_value}% (Lo·∫°i: ${promo.discount_type})<br>
                                T·ª´ ${new Date(promo.valid_from).toLocaleDateString('vi-VN')} ƒë·∫øn ${new Date(promo.valid_until).toLocaleDateString('vi-VN')}<br>
                                C√≤n: ${promo.max_usage - promo.current_usage} l·∫ßn s·ª≠ d·ª•ng
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="color: #999;">Kh√¥ng c√≥ khuy·∫øn m√£i n√†o</p>';
                }
                
                document.getElementById('promotionsList').innerHTML = html;
            } catch (err) {
                document.getElementById('promotionsList').innerHTML = `<div class="notification error">‚ùå L·ªói: ${err.message}</div>`;
            }
        }

        // APPLY COUPON
        async function applyCoupon() {
            if (!authToken) {
                showResult('couponResult', '‚ùå Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!', 'error');
                return;
            }

            const code = document.getElementById('couponCode').value;
            const orderId = parseInt(document.getElementById('couponOrderId').value);
            const amount = parseInt(document.getElementById('couponAmount').value);

            if (!code || !orderId || !amount) {
                showResult('couponResult', '‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/coupons/apply`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        coupon_code: code,
                        order_id: orderId,
                        original_amount: amount
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    showResult('couponResult', 
                        ` √Åp D·ª•ng Th√†nh C√¥ng!\n\nM√£: ${data.coupon_code}\nGi√° g·ªëc: ${amount.toLocaleString()} VND\nGi·∫£m: ${data.discount_amount.toLocaleString()} VND\nüî¥ Gi√° cu·ªëi: ${data.final_amount.toLocaleString()} VND`, 
                        'success');
                } else {
                    showResult('couponResult', `‚ùå L·ªói: ${data.detail || '√Åp d·ª•ng th·∫•t b·∫°i'}`, 'error');
                }
            } catch (err) {
                showResult('couponResult', `‚ùå L·ªói: ${err.message}`, 'error');
            }
        }

        // SUBMIT RATING
        async function submitRating() {
            if (!authToken) {
                showResult('ratingResult', 'Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!', 'error');
                return;
            }

            const productId = document.getElementById('ratingProductId').value;
            const rating = parseInt(document.getElementById('ratingScore').value);
            const title = document.getElementById('ratingTitle').value;
            const comment = document.getElementById('ratingComment').value;

            if (!productId || !title || !comment) {
                showResult('ratingResult', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }

            // Ki·ªÉm tra xem user ƒë√£ mua s·∫£n ph·∫©m n√†y ch∆∞a
            try {
                const checkResponse = await fetch(`/api/orders?skip=0&limit=100`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const ordersData = await checkResponse.json();
                
                let hasPurchased = false;
                if (ordersData.orders && Array.isArray(ordersData.orders)) {
                    hasPurchased = ordersData.orders.some(order => {
                        if (order.items && Array.isArray(order.items)) {
                            return order.items.some(item => item.product_id === productId);
                        }
                        return false;
                    });
                }
                
                if (!hasPurchased) {
                    showResult('ratingResult', 'B·∫°n ph·∫£i mua s·∫£n ph·∫©m n√†y tr∆∞·ªõc khi ƒë√°nh gi√°!', 'error');
                    return;
                }
            } catch (e) {
                console.log('Kh√¥ng th·ªÉ ki·ªÉm tra l·ªãch s·ª≠ mua h√†ng, ti·∫øp t·ª•c ƒë√°nh gi√°');
            }

            try {
                const response = await fetch(`/api/ratings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        user_id: parseInt(userId),
                        rating,
                        title,
                        comment,
                        verified_purchase: true
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    showResult('ratingResult', 
                        `ƒê√°nh Gi√° Th√†nh C√¥ng!\n\n${rating}‚≠ê - ${title}\n${comment}`, 
                        'success');
                    document.getElementById('ratingTitle').value = '';
                    document.getElementById('ratingComment').value = '';
                } else {
                    showResult('ratingResult', `L·ªói: ${data.detail || 'ƒê√°nh gi√° th·∫•t b·∫°i'}`, 'error');
                }
            } catch (err) {
                showResult('ratingResult', `L·ªói: ${err.message}`, 'error');
            }
        }

        // VIEW PRODUCT RATINGS
        async function viewProductRatings() {
            const productId = document.getElementById('viewRatingProductId').value;
            if (!productId) {
                showResult('productRatingsResult', 'Vui l√≤ng nh·∫≠p ID s·∫£n ph·∫©m!', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/ratings/product/${productId}`);
                const data = await response.json();
                
                if (!data.ratings || !Array.isArray(data.ratings)) {
                    showResult('productRatingsResult', 'Kh√¥ng c√≥ ƒë√°nh gi√°', 'error');
                    return;
                }
                
                let html = `
                    <div class="notification info">
                        <strong>üìä ƒê√°nh Gi√° S·∫£n Ph·∫©m</strong><br>
                        ƒêi·ªÉm trung b√¨nh: ${data.average_rating}/5 ‚≠ê<br>
                        T·ªïng ƒë√°nh gi√°: ${data.total_ratings}
                    </div>
                `;
                
                if (data.ratings.length > 0) {
                    data.ratings.forEach(rating => {
                        html += `
                            <div class="list-item">
                                <strong>${rating.rating}‚≠ê - ${rating.title}</strong><br>
                                üë§ ${rating.user.username}<br>
                                ${rating.comment}
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="color: #999;">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o</p>';
                }
                
                document.getElementById('productRatingsResult').innerHTML = html;
            } catch (err) {
                showResult('productRatingsResult', `‚ùå L·ªói: ${err.message}`, 'error');
            }
        }

        // ADD TO FAVOURITE
        async function addToFavourite() {
            if (!authToken) {
                showResult('favResult', '‚ùå Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!', 'error');
                return;
            }

            const productId = document.getElementById('favProductId').value;
            if (!productId) {
                showResult('favResult', '‚ùå Vui l√≤ng nh·∫≠p ID s·∫£n ph·∫©m!', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/favourites`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        user_id: parseInt(userId),
                        product_id: productId
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    showResult('favResult', ` Th√™m Y√™u Th√≠ch Th√†nh C√¥ng!`, 'success');
                } else {
                    showResult('favResult', `‚ùå L·ªói: ${data.detail || 'Th√™m y√™u th√≠ch th·∫•t b·∫°i'}`, 'error');
                }
            } catch (err) {
                showResult('favResult', `‚ùå L·ªói: ${err.message}`, 'error');
            }
        }

        // GET FAVOURITES
        async function getFavourites() {
            if (!authToken) {
                showResult('favouritesList', 'Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/favourites?user_id=${userId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                if (!data.favourites || !Array.isArray(data.favourites)) {
                    document.getElementById('favouritesList').innerHTML = `<div class="notification">Kh√¥ng c√≥ s·∫£n ph·∫©m y√™u th√≠ch</div>`;
                    return;
                }
                
                let html = `<h3>‚ù§Ô∏è ${data.favourites.length} s·∫£n ph·∫©m y√™u th√≠ch</h3>`;
                
                if (data.favourites.length > 0) {
                    data.favourites.forEach(fav => {
                        html += `
                            <div class="list-item">
                                <strong>‚ù§Ô∏è ${fav.product.name}</strong><br>
                                üí∞ ${fav.product.price.toLocaleString()} VND
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="color: #999;">Ch∆∞a c√≥ s·∫£n ph·∫©m y√™u th√≠ch n√†o</p>';
                }
                
                document.getElementById('favouritesList').innerHTML = html;
            } catch (err) {
                showResult('favouritesList', `‚ùå L·ªói: ${err.message}`, 'error');
            }
        }

        // GET NOTIFICATIONS
        async function getNotifications() {
            if (!authToken) {
                showResult('notificationsList', 'Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/notifications?user_id=${userId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                if (!data.notifications || !Array.isArray(data.notifications)) {
                    document.getElementById('notificationsList').innerHTML = `<div class="notification">Kh√¥ng c√≥ th√¥ng b√°o</div>`;
                    return;
                }
                
                let html = `<h3>üì¨ ${data.unread_count || 0} th√¥ng b√°o ch∆∞a ƒë·ªçc</h3>`;
                
                if (data.notifications.length > 0) {
                    data.notifications.forEach(notif => {
                        const status = notif.read ? '‚úì' : 'üÜï';
                        html += `
                            <div class="list-item">
                                ${status} <strong>[${notif.type}] ${notif.title}</strong><br>
                                ${notif.message}<br>
                                <small>${new Date(notif.created_at).toLocaleString('vi-VN')}</small>
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="color: #999;">Kh√¥ng c√≥ th√¥ng b√°o n√†o</p>';
                }
                
                document.getElementById('notificationsList').innerHTML = html;
            } catch (err) {
                showResult('notificationsList', `L·ªói: ${err.message}`, 'error');
            }
        }

        // CHECK INVENTORY
        async function checkInventory() {
            const productId = document.getElementById('inventoryProductId').value;
            if (!productId) {
                showResult('inventoryResult', 'Vui l√≤ng nh·∫≠p ID s·∫£n ph·∫©m!', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/inventory/${productId}`);
                const data = await response.json();
                
                let html = `
                    <div class="notification info">
                        <strong>üì¶ Ki·ªÉm Tra Kho</strong><br>
                        T·ªìn kho: ${data.quantity_in_stock} c√°i<br>
                        ƒê√£ ƒë·∫∑t: ${data.quantity_reserved} c√°i<br>
                        C√≤n b√°n: ${data.quantity_available} c√°i<br>
                        M·ª©c t√°i nh·∫≠p: ${data.reorder_level} c√°i
                    </div>
                `;
                
                document.getElementById('inventoryResult').innerHTML = html;
            } catch (err) {
                showResult('inventoryResult', `L·ªói: ${err.message}`, 'error');
            }
        }

        // GET LOW STOCK
        async function getLowStock() {
            try {
                const response = await fetch(`/api/inventory/low-stock`);
                const data = await response.json();
                
                if (!data.low_stock_items || !Array.isArray(data.low_stock_items)) {
                    document.getElementById('lowStockResult').innerHTML = `<div class="notification">Kh√¥ng c√≥ th√¥ng tin kho</div>`;
                    return;
                }
                
                let html = `<h3>‚ö†Ô∏è S·∫£n ph·∫©m s·∫Øp h·∫øt (${data.low_stock_items.length})</h3>`;
                
                if (data.low_stock_items.length > 0) {
                    data.low_stock_items.forEach(item => {
                        html += `
                            <div class="list-item" style="border-left-color: #dc3545;">
                                <strong>‚ö†Ô∏è ${item.product_name}</strong><br>
                                T·ªìn kho: ${item.quantity_in_stock} c√°i (M·ª©c: ${item.reorder_level})
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="color: #999;">T·∫•t c·∫£ s·∫£n ph·∫©m ƒë·ªÅu ƒë·ªß kho</p>';
                }
                
                document.getElementById('lowStockResult').innerHTML = html;
            } catch (err) {
                showResult('lowStockResult', `L·ªói: ${err.message}`, 'error');
            }
        }

        // SEARCH PRODUCTS
        async function searchProducts() {
            const query = prompt('Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm:');
            if (!query) return;

            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (!data.results || !Array.isArray(data.results)) {
                    document.getElementById('searchResult').innerHTML = `<div class="notification">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</div>`;
                    return;
                }
                
                let html = `<h3>üîç K·∫øt qu·∫£ t√¨m ki·∫øm: "${query}"</h3>`;
                html += `<p>T√¨m ƒë∆∞·ª£c ${data.results.length} s·∫£n ph·∫©m</p>`;
                
                if (data.results.length > 0) {
                    data.results.forEach(product => {
                        html += `
                            <div class="product-card">
                                <h4>${product.name}</h4>
                                <p class="price">üí∞ ${product.price.toLocaleString()} VND</p>
                                <p>Rating: ${product.rating || 0}‚≠ê</p>
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="color: #999;">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o</p>';
                }
                
                document.getElementById('productsList').innerHTML = html;
            } catch (err) {
                document.getElementById('productsList').innerHTML = `<div class="notification error">‚ùå L·ªói: ${err.message}</div>`;
            }
        }

        // HELPER FUNCTIONS
        function showResult(elementId, message, type) {
            const resultDiv = document.getElementById(elementId);
            resultDiv.innerHTML = `
                <div class="result ${type}">
                    <h4>${type === 'success' ? 'Th√†nh c√¥ng' : type === 'error' ? 'L·ªói' : 'Th√¥ng tin'}</h4>
                    <pre>${message}</pre>
                </div>
            `;
        }

        // SELECT PRODUCT (t·ª± ƒë·ªông ƒëi·ªÅn ID v√† gi√°)
        // SELECT PRODUCT (t·ª± ƒë·ªông ƒëi·ªÅn ID v√† gi√°)
        function selectProduct(productId, price) {
            document.getElementById('productId').value = productId;
            document.getElementById('productPrice').value = price;
            document.getElementById('quantity').value = 1;
            document.getElementById('promotionId').value = '';
            document.getElementById('taxId').value = '';
            calculateTotal();
            loadPromotions();  // T·∫£i danh s√°ch khuy·∫øn m√£i
            loadTaxRates();    // T·∫£i danh s√°ch thu·∫ø
            
            // Cu·ªôn ƒë·∫øn ph·∫ßn form t·∫°o ƒë∆°n h√†ng
            document.getElementById('orders').scrollIntoView({ behavior: 'smooth' });
            showResult('orderResult', `‚úÖ ƒê√£ ch·ªçn s·∫£n ph·∫©m!\n\nID: ${productId}\nGi√°: ${price.toLocaleString()} VND\n\nVui l√≤ng ch·ªânh s·ª≠a s·ªë l∆∞·ª£ng, ch·ªçn khuy·∫øn m√£i v√† thu·∫ø r·ªìi click "T·∫°o ƒê∆°n H√†ng"`, 'success');
        }

        // LOAD PROMOTIONS
        async function loadPromotions() {
            try {
                const response = await fetch(`/api/promotions?status=active`);
                const data = await response.json();
                
                let promotionSelect = document.getElementById('promotionId');
                promotionSelect.innerHTML = '<option value="">-- Kh√¥ng c√≥ khuy·∫øn m√£i --</option>';
                
                if (data.promotions && Array.isArray(data.promotions)) {
                    data.promotions.forEach(promo => {
                        const option = document.createElement('option');
                        option.value = promo._id || promo.id;
                        option.textContent = `${promo.code} (${promo.discount_percent || promo.discount_amount}${promo.discount_percent ? '%' : ' VND'})`;
                        option.dataset.discount = promo.discount_percent || 0;
                        promotionSelect.appendChild(option);
                    });
                }
            } catch (err) {
                console.error('Error loading promotions:', err);
            }
        }

        // LOAD TAX RATES
        async function loadTaxRates() {
            try {
                const response = await fetch(`/api/tax`);
                const data = await response.json();
                
                let taxSelect = document.getElementById('taxId');
                taxSelect.innerHTML = '<option value="">-- Kh√¥ng c√≥ thu·∫ø --</option>';
                
                if (data.tax_rates && Array.isArray(data.tax_rates)) {
                    data.tax_rates.forEach(tax => {
                        const option = document.createElement('option');
                        option.value = tax._id || tax.id;
                        option.textContent = `${tax.name || tax.type} (${tax.rate}%)`;
                        option.dataset.rate = tax.rate || 0;
                        taxSelect.appendChild(option);
                    });
                } else if (data.rate !== undefined) {
                    // N·∫øu API ch·ªâ tr·∫£ v·ªÅ m·ªôt tax rate
                    const option = document.createElement('option');
                    option.value = 'default';
                    option.textContent = `M·∫∑c ƒë·ªãnh (${data.rate}%)`;
                    option.dataset.rate = data.rate || 0;
                    taxSelect.appendChild(option);
                }
            } catch (err) {
                console.error('Error loading tax rates:', err);
            }
        }

        function copyToInput(inputId, value) {
            const inputElement = document.getElementById(inputId);
            
            // N·∫øu kh√¥ng c√≥ value, th·ª≠ l·∫•y t·ª´ lastOrderId
            if (!value && inputId === 'paymentOrderId' && window.lastOrderId) {
                value = window.lastOrderId;
            }
            
            if (!inputElement) {
                showResult('orderResult', '‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y tr∆∞·ªùng nh·∫≠p!', 'error');
                return;
            }
            
            if (!value || value === 'undefined' || value === 'N/A') {
                showResult('orderResult', `‚ùå L·ªói: Kh√¥ng c√≥ ID ƒë·ªÉ sao ch√©p!\nValue: ${value}`, 'error');
                return;
            }
            
            inputElement.value = value;
            inputElement.focus();
            inputElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Hi·ªÉn th·ªã lo·∫°i ID ƒë√£ sao ch√©p
            let message = '';
            if (inputId === 'productId') {
                message = `‚úÖ ƒê√£ sao ch√©p ID s·∫£n ph·∫©m: ${value}\n\nVui l√≤ng ƒëi·ªÅn s·ªë l∆∞·ª£ng v√† click "T·∫°o ƒê∆°n H√†ng"`;
                showResult('orderResult', message, 'success');
            } else if (inputId === 'paymentOrderId') {
                message = `‚úÖ ƒê√£ sao ch√©p ID ƒë∆°n h√†ng: ${value}\n\nVui l√≤ng ƒëi·ªÅn s·ªë ti·ªÅn v√† ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n`;
                showResult('paymentResult', message, 'success');
            } else {
                message = `‚úÖ ƒê√£ sao ch√©p: ${value}`;
                showResult('orderResult', message, 'success');
            }
        }
    </script>
</body>
</html>
